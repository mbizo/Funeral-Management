{% extends "base.html" %}
{% block content %}
<h3>Reports</h3>
<form method="post" class="card card-body">
  <div class="row g-2">
    <div class="col-md-3">
      <label class="form-label">Report</label>
      <select class="form-select" name="report_type">
        <option value="new_policies" {% if report_type=='new_policies' %}selected{% endif %}>New Policies (by date range)</option>
        <option value="active_policies" {% if report_type=='active_policies' %}selected{% endif %}>Active Policies</option>
        <option value="lapsed_policies" {% if report_type=='lapsed_policies' %}selected{% endif %}>Lapsed Policies</option>
        <option value="agent_commissions" {% if report_type=='agent_commissions' %}selected{% endif %}>Agent Commissions (by date range)</option>
      </select>
    </div>
    <div class="col-md-3"><label class="form-label">Start</label><input type="date" class="form-control" name="start_date" value="{{ start_date }}"></div>
    <div class="col-md-3"><label class="form-label">End</label><input type="date" class="form-control" name="end_date" value="{{ end_date }}"></div>
    <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100">Run</button></div>
  </div>
</form>

{% if new_policies is defined %}
<h5 class="mt-3">New Policies</h5>
<table class="table table-striped">
  <thead><tr><th>Created</th><th>Policy #</th><th>Holder</th><th>Agent</th><th>Premium</th><th>Status</th></tr></thead>
  <tbody>
    {% for p in new_policies %}
    <tr><td>{{ p.created_at.strftime('%Y-%m-%d') }}</td><td>{{ p.policy_number }}</td><td>{{ p.holder.full_name }}</td><td>{{ p.agent.name if p.agent else '' }}</td><td>{{ '%.2f' % p.premium_amount }}</td><td>{{ p.status }}</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

{% if active_policies is defined %}
<h5 class="mt-3">Active Policies</h5>
<ul class="list-group">
  {% for p in active_policies %}
  <li class="list-group-item d-flex justify-content-between"><span>{{ p.policy_number }} — {{ p.holder.full_name }}</span><span class="badge bg-success">Active</span></li>
  {% endfor %}
</ul>
{% endif %}

{% if lapsed_policies is defined %}
<h5 class="mt-3">Lapsed Policies</h5>
<ul class="list-group">
  {% for p in lapsed_policies %}
  <li class="list-group-item d-flex justify-content-between"><span>{{ p.policy_number }} — {{ p.holder.full_name }}</span><span class="badge bg-danger">Lapsed</span></li>
  {% endfor %}
</ul>
{% endif %}

{% if commissions is defined %}
<h5 class="mt-3">Agent Commissions</h5>
<table class="table table-striped">
  <thead><tr><th>Date</th><th>Agent</th><th>Policy #</th><th>Holder</th><th>Payment</th><th>Commission</th></tr></thead>
  <tbody>
    {% for c in commissions %}
    <tr><td>{{ c.payment.paid_at.strftime('%Y-%m-%d') }}</td><td>{{ c.agent.name }}</td><td>{{ c.payment.policy.policy_number }}</td><td>{{ c.payment.policy.holder.full_name }}</td><td>{{ '%.2f' % c.payment.amount }}</td><td>{{ '%.2f' % c.amount }}</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
{% endblock %}
