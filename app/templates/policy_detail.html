{% extends "base.html" %}
{% block content %}
<h3>Policy {{ policy.policy_number }}</h3>
<div class="mb-2">
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('core.policy_document', policy_id=policy.id) }}">Download Policy PDF</a>
</div>
<div class="row g-3">
  <div class="col-md-6">
    <div class="card card-body">
      <h5>Policyholder</h5>
      <div><strong>{{ policy.holder.full_name }}</strong></div>
      <div>{{ policy.holder.national_id }}</div>
      <div>{{ policy.holder.phone }} | {{ policy.holder.email }}</div>
      <div>{{ policy.holder.address }}</div>
    </div>
    <div class="card card-body mt-3">
      <h5>Members</h5>
      <table class="table table-sm">
        <thead><tr><th>Name</th><th>Relationship</th><th>DOB</th><th>ID</th></tr></thead>
        <tbody>
          {% for m in policy.members %}
          <tr><td>{{ m.full_name }}</td><td>{{ m.relationship }}</td><td>{{ m.date_of_birth }}</td><td>{{ m.national_id }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <form method="post" class="row g-2">
        <input type="hidden" name="action" value="add_member">
        <div class="col-md-4"><input class="form-control" name="full_name" placeholder="Full name" required></div>
        <div class="col-md-3"><input class="form-control" name="relationship" placeholder="Relationship"></div>
        <div class="col-md-3"><input type="date" class="form-control" name="date_of_birth"></div>
        <div class="col-md-2"><input class="form-control" name="national_id" placeholder="ID"></div>
        <div class="col-12 mt-2"><button class="btn btn-success btn-sm">Add Member</button></div>
      </form>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card card-body">
      <h5>Policy Details</h5>
      <form method="post" class="row g-2">
        <input type="hidden" name="action" value="update_policy">
        <div class="col-md-4">
          <label class="form-label">Agent</label>
          <select name="agent_id" class="form-select" disabled>
            <option>{{ policy.agent.name if policy.agent else 'None' }}</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            {% for s in ['Active','Lapsed','Cancelled'] %}
            <option value="{{ s }}" {% if policy.status==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2"><label class="form-label">Grace</label><input type="number" class="form-control" name="grace_days" value="{{ policy.grace_days }}"></div>
        <div class="col-md-4"><label class="form-label">Start</label><input class="form-control" value="{{ policy.start_date }}" disabled></div>
        <div class="col-md-6"><label class="form-label">Premium</label><input type="number" step="0.01" class="form-control" name="premium_amount" value="{{ policy.premium_amount }}"></div>
        <div class="col-md-6"><label class="form-label">Benefit amount</label><input type="number" step="0.01" class="form-control" name="benefit_amount" value="{{ policy.benefit_amount }}"></div>
        <div class="col-md-12"><label class="form-label">Benefit description</label><input class="form-control" name="benefit_description" value="{{ policy.benefit_description }}"></div>
        <div class="col-12 mt-2"><button class="btn btn-primary">Save Changes</button></div>
      </form>
    </div>

    <div class="card card-body mt-3">
      <h5>Payments</h5>
      <table class="table table-sm">
        <thead><tr><th>Date</th><th>Amount</th></tr></thead>
        <tbody>
          {% for p in policy.payments %}
          <tr><td>{{ p.paid_at.strftime('%Y-%m-%d %H:%M') }}</td><td>{{ '%.2f' % p.amount }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <form method="post" class="row g-2">
        <input type="hidden" name="action" value="record_payment">
        <div class="col-md-4"><input type="number" step="0.01" name="amount" class="form-control" placeholder="Amount" required></div>
        <div class="col-md-3"><button class="btn btn-success btn-sm">Record Payment</button></div>
        <div class="col-md-5 d-flex align-items-center"><span class="badge bg-{{ 'success' if policy.status=='Active' else 'danger' }}">Status: {{ policy.status }}</span></div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
